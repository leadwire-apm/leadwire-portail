<?php declare(strict_types=1);

namespace {{ namespace }}\Controller\Rest;

{% block use_statements %}
use ATS\CoreBundle\Controller\Rest\BaseRestController;
use FOS\RestBundle\Controller\Annotations\Route;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\HttpKernel\Exception\BadRequestHttpException;
use ATS\CoreBundle\Service\Voter\AclVoter;
use ATS\CoreBundle\HTTPFoundation\CsvResponse;
use ATS\CoreBundle\Service\Exporter\Exporter;
use {{ namespace }}\Service\{{ entity }}Service;
{% endblock use_statements %}

{% block class_definition %}
class {{ entity }}Controller extends BaseRestController
{% endblock class_definition %}
{
{% block class_body %}
    /**
     * @Route("/{id}/get", methods="GET")
     *
     * @param Request $request
     * @param {{ entity }}Service ${{ entity | lower }}Service
     * @param string  $id
     *
     * @return Response
     */
    public function get{{ entity }}Action(Request $request, {{ entity }}Service ${{ entity | lower }}Service, $id)
    {
        $data = ${{ entity | lower }}Service->get{{ entity }}($id);
        $this->denyAccessUnlessGranted(AclVoter::VIEW, $data);

        return $this->prepareJsonResponse($data);
    }

    /**
     * @Route("/list", methods="GET")
     *
     * @param Request $request
     * @param {{ entity }}Service ${{ entity | lower }}Service
     *
     * @return Response
     */
    public function list{{ entity }}sAction(Request $request, {{ entity }}Service ${{ entity | lower }}Service)
    {
        $this->denyAccessUnlessGranted(AclVoter::VIEW_ALL, {{ entity }}::class);
        $data = ${{ entity | lower }}Service->list{{ entity }}s();

        return $this->prepareJsonResponse($data);
    }

    /**
     * @Route(
     *    "/paginate/{pageNumber}/{itemsPerPage}",
     *    methods="GET",
     *    defaults={"pageNumber" = 1, "itemsPerPage" = 20}
     * )
     *
     * @param Request $request
     * @param {{ entity }}Service ${{ entity | lower }}Service
     * @param int $pageNumber
     * @param int $itemsPerPage
     *
     * @return Response
     */
    public function paginate{{ entity }}sAction(
        Request $request,
        {{ entity }}Service ${{ entity | lower }}Service,
        $pageNumber,
        $itemsPerPage
    ) {
        $this->denyAccessUnlessGranted(AclVoter::VIEW_ALL, {{ entity }}::class);
        $pageResult = ${{ entity | lower }}Service->paginate($pageNumber, $itemsPerPage);

        return $this->prepareJsonResponse($pageResult);
    }

    /**
     * @Route("/new", methods="POST")
     *
     * @param Request $request
     * @param {{ entity }}Service ${{ entity | lower }}Service
     *
     * @return Response
     */
    public function new{{ entity }}Action(Request $request, {{ entity }}Service ${{ entity | lower }}Service)
    {
        $this->denyAccessUnlessGranted(AclVoter::CREATE, {{ entity }}::class);
        $data = $request->getContent();
        $successful = ${{ entity | lower }}Service->new{{ entity }}($data);

        return $this->prepareJsonResponse($successful);
    }

    /**
    * @Route("/{id}/update", methods="PUT")
    *
    * @param Request $request
    * @param {{ entity }}Service ${{ entity | lower }}Service
    *
    * @return Response
    */
    public function update{{ entity }}Action(Request $request, {{ entity }}Service ${{ entity | lower }}Service)
    {
        $data = $request->getContent();
        $successful = ${{ entity | lower }}Service->update{{ entity }}($data);

        return $this->prepareJsonResponse($successful);
    }

    /**
     * @Route("/{id}/delete", methods="DELETE")
     *
     * @param Request $request
     * @param {{ entity }}Service ${{ entity | lower }}Service
     * @param string $id
     *
     * @return Response
     */
    public function delete{{ entity }}Action(Request $request, {{ entity }}Service ${{ entity | lower }}Service, $id)
    {
        $this->denyAccessUnlessGranted(AclVoter::DELETE, {{ entity }}::class);
        ${{ entity | lower }}Service->delete{{ entity }}($id);

        return $this->prepareJsonResponse([]);
    }

    /**
     * @Route("/{lang}/{term}/search", methods="GET", defaults={"lang" = "en"})
     *
     * @param Request $request
     * @param {{ entity }}Service ${{ entity | lower }}Service
     * @param string $term
     * @param string $lang
     *
     * @return Response
     */
    public function search{{ entity }}Action(Request $request, {{ entity }}Service ${{ entity | lower }}Service, $term, $lang)
    {
        $this->denyAccessUnlessGranted(AclVoter::SEARCH, {{ entity }}::class);

        try {
            $result = $todoService->textSearch($term, $lang);
        } catch (\MongoException $e) {
            throw new BadRequestHttpException("Entity " . {{ entity }}::class . " is not searchable. ");
        }

        return $this->prepareJsonResponse(${{ entity | lower }}Service->textSearch($term, $lang));
    }

    /**
     * @Route("/csv-export", methods="POST")
     *
     * @param Request $request
     * @param Exporter $exporter
     *
     * @return CsvResponse
     */
    public function generateCsvExportAction(Request $request, Exporter $exporter)
    {
        $this->denyAccessUnlessGranted(AclVoter::EXPORT, {{ entity }}::class);
        $data = json_decode($request->getContent(), true);

        $exported = $exporter
            ->setFormat(Exporter::FORMAT_CSV)
            ->setEntity({{ entity }}::class)
            ->setFilter($data['filter'])
            ->setSchema(explode(',', $data['schema']))
            ->export()
            ->getRawData()
        ;

        return new CsvResponse($exported);
    }
{% endblock class_body %}
}
